---
title: "Impact of reorganization on program composition"
author: "Jay Hesselberth"
date: "4/14/2020"
output:
  html_document:
    code_folding: "hide"
---

```{r setup, include=FALSE}
library(tidyverse)
library(glue)
library(cowplot)
library(colorblindr)
library(readxl)
library(gt)
library(UpSetR)
```

```{r assoc_current}
# burn it
setwd("~/Dropbox (Hesselberth Lab)/Service/Reilly Graduate School Task Force")

assoc_current_wide <- read_excel("Faculty affiliations.xlsx") %>%
  pivot_longer(-faculty.member) %>%
  mutate(value = as.integer(value)) %>%
  pivot_wider(names_from = name, values_from = value)

assoc_current <- pivot_longer(assoc_current_wide, -faculty.member, names_to = "program") %>%
  filter(value == 1) %>%
  set_names(c("faculty.member", "program", "value")) %>%
  select(faculty.member, program)

new_assoc_current_wide <- read_excel("Faculty affiliations.xlsx", sheet = 2) %>%
  pivot_longer(-faculty.member) %>%
  replace_na(list(value = 0)) %>%
  mutate(value = as.integer(value)) %>%
  pivot_wider(names_from = name, values_from = value)

new_assoc_current <- pivot_longer(new_assoc_current_wide, -faculty.member, names_to = "program") %>%
  filter(value == 1) %>%
  set_names(c("faculty.member", "program", "value")) %>%
  select(faculty.member, program)

n.faculty.curr <- length(unique(assoc_current$faculty.member))
n.prog.curr <- length(unique(assoc_current$program))

n.faculty.new <- length(unique(new_assoc_current$faculty.member))
n.prog.new <- length(unique(new_assoc_current$program))
```

```{r program_sizes, eval = FALSE, include = FALSE}
prog_sizes <- count(assoc_current, program, sort = TRUE)

ggplot(prog_sizes, aes(reorder(program, -n), n)) +
  geom_col() +
  theme_minimal_hgrid() +
  labs(
    x = "",
    y = "Training Faculty",
    title = "Current Program Sizes"
  )
```

```{r plot_affil, eval = FALSE, include = FALSE}
# counts of counts
affil_counts <- count(assoc_current, faculty.member) %>% count(n)
  
ggplot(affil_counts, aes(n, nn, fill = factor(n))) +
  geom_col() +
  labs(
    x = "Program Affiliations",
    y = "Number of Faculty",
    title = "Current Program Faculty Distribution",
    subtitle = glue(
      "{fac} faculty across {prog} programs",
      fac = n.faculty.curr,
      prog = n.prog.curr 
    )
  ) +
  scale_fill_OkabeIto() +
  theme_minimal_hgrid() +
  theme(legend.position = "none")
```

## Raw data

The raw data for this analysis is on this [Google Sheet](https://docs.google.com/spreadsheets/d/1Q8lkPItX6yhoiIXoMKxbA0KG3qxSmmIQ3oFeb0ZH4DE/edit?usp=sharing).

* The "Current" tab contains the data from the GS survey of program memberships prepared for the Engelke task force.

* The "Proposed" tab contains my assignments (marked with "1"s) of faculty to the new structure. I'm pretty comfortable with most of these assignments, but please let me know if you have quibbles. In this exercise I learned there are several training faculty at AMC I have never heard of, so relied on CU Profiles to help me choose.

**In our current program structure, there are `r glue("{fac} faculty across {prog} programs", fac = n.faculty.curr, prog = n.prog.curr)`**.

## Program composition

These plots illustrate the size and overlaps of training faculty across programs. 

If you've never seen ["upset" plots](https://academic.oup.com/bioinformatics/article/33/18/2938/3884387) before, they're worth digesting:

* the **Set Size** (bottom left) plots the total size of each category. For example, the total number of faculty in MOLB is 67.

* the **Intersection Size** (main plot) is the total number of faculty in each combination, represented by one or more connected dots below the columns. For the left-most columns, each set is comprised of only one program, i.e. the faculty who are associated uniquely with that program. For example, there are 36 faculty who are uniquely associated with IMMU. Faculty who are in one or more programs are represented by connected dots. For example, there are 10 faculty who are in both NRSC and PHCL (also note these 10 are *only* in NRSC and PHCL).

### Current program structure

The first plot is our current program structure, with compositions from the GS survey of program memberships collected as part of the Engelke task force.

```{r prog_upset_curr, fig.width = 10}
upset(as.data.frame(assoc_current_wide), nsets = n.prog.curr, nintersects = NA)
```

Note the large number of combinations, with many comprised of a small number of faculty (often a single person).

### Proposed program structure

This plot represents the proposed program structure, with my faculty assignments from the sheet above.

1.	Cell and Molecular Biology (**CMB**)
2.	Neurobiology (**NEURO**)
3.	Immunology and Microbiology (**IM**)
4.	Cancer Biology and Pharmacology (**CAN**)
5.	Human Genomics and Computational Biology (**HGCB**)

```{r prog_upset_new, fig.width = 10}
upset(as.data.frame(new_assoc_current_wide), nsets = n.prog.new, nintersects = NA)
```

* There are *many* fewer combinations. As I went through assigning faculty, in many cases it was obvious what the primary association(s) should be; everyone is affiliated with 1 or 2 programs. 

* (caveat: there are ~50 training faculty I've never heard of; would appreciate a double-check of the raw data).

* Notable exceptions to obvious mappings were:

  1. faculty currently in IPHYS with a metabolism / endocrinology focus; I put them in HGCB. 
  
  2. 10-15 clinical researchers without an obvious home; for example, Peter Buttrick is in the list, which program would he gravitate to? HGCB?

* The sizes of unique associations are roughly uniform, with four of the new programs each comprised of 70-80 faculty. CAN (Cancer Biology and Pharmacology) is a bit smaller with 51 total faculty (42 plus the overlaps).
